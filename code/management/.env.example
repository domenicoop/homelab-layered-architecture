# ====================================================================
#
#          Master Configuration for Homelab VM Management
#
# ====================================================================
#
# This file centralizes configuration for all management scripts.

# --- General & Shared Settings ---

# The primary administrative user on the host.
# Used by storage_manager.py to set group permissions.
# It defaults to the SUDO_USER or 'runner'.

ADMIN_USER=runner

HOME_DIR=/home/${ADMIN_USER}

MANAGEMENT_DIR=${HOME_DIR}/management
PYTHON_DIR=${MANAGEMENT_DIR}/python
DOCKER_DIR=${MANAGEMENT_DIR}/docker

VENV_DIR=${PYTHON_DIR}/.venv
REQUIREMENTS_FILE=${PYTHON_DIR}/requirements.txt

# --- Storage Settings ---

# The parent ZFS dataset containing all service data.
# Used by: run_backup.py, storage_manager.py, zfs_snapshot.py
ZFS_PARENT_DATASET=datapool/services

# The base directory where the parent ZFS dataset is mounted.
# Used by: storage_manager.py
ZFS_BASE_MOUNTPOINT=/datapool/services

# --- Backup Settings ---

BORG_EXCLUDES_FILE=${MANAGEMENT_DIR}/borg_excludes.txt

# The full remote path for your Borg repositories.
# This MUST be in the ssh:// format for remote backups.
# The script will create subdirectories here, e.g., .../homelab/datapool_services
BORG_REPO_BASE_PATH="ssh://user@domain/./borg-backups/homelab"

# [SECRET - REQUIRED] The passphrase for encrypting the Borg repositories.
BORG_PASSPHRASE=secret

# The directory containing encryption keys for Borg.
BORG_KEYS_DIR=${MANAGEMENT_DIR}/borg_keys

# The full SSH command for Borg to use.
# This tells Borg to use a specific port (-p 23) and your private key (-i ...).
# Ensure this path to the key is correct and readable by the root user.
BORG_RSH="ssh -o ServerAliveInterval=60 -p 23 -i /home/runner/.ssh/borg_backup/borg_backup_key"

# The prefix for the Borg archive name. The timestamp will be appended.
# Example: auto-backup-2025-09-03_21-00-00
ARCHIVE_PREFIX="auto-backup"

# Borg compression settings.
BORG_COMPRESSION="zlib,7"

# Borg prune retention policy.
# If you remove this line, a default policy will be used.
BORG_PRUNE_POLICY="--keep-daily 7 --keep-weekly 4 --keep-monthly 6"

# --- Storage & Permissions ---

# The shared group for the admin user and container processes to access storage.
SHARED_GROUP=storage-access

# The user created on the host to map to the container's root user.
# The UID for this user must match REMAPPED_ROOT_UID.
DOCKER_USER=dockeruser

# Mapped UIDs for Docker User Namespace Remap.
# These UIDs are used to create corresponding system users on the host.
REMAPPED_ROOT_UID=100000 # Maps to uid 0 in containers
REMAPPED_POSTGRES_UID=100999 # Maps to uid 999 in containers
REMAPPED_APP_UID=101000 # Maps to uid 1000 in containers


# --- Service Definitions ---
#
# Maps service directory paths to their required owner UID on the host.
# This format uses backslashes for multi-line support in make.
# Format: "relative/path:UID"
SERVICE_VOLUME_PATHS_AND_OWNERS="gitversioncontrol/gitea/data:REMAPPED_APP_UID
gitversioncontrol/gitea/config:REMAPPED_APP_UID
gitversioncontrol/gitea/postgres:REMAPPED_POSTGRES_UID
vpnexitnode/tailscale/config:REMAPPED_ROOT_UID
vpnexitnode/tailscale/state:REMAPPED_ROOT_UID
syncprojects/syncthing/data:REMAPPED_APP_UID"