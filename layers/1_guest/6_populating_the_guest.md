# 6 Populating the Guest: Configs, Services, and Scripts

With the hardened Debian OS, ZFS, and Docker installed, the virtual machine is an empty, secure shell. This guide explains how we "fill" it with the intelligence: the **automation scripts**, the **service configurations** (Docker Compose), and the **persistent data** itself.

This "filling" happens in two distinct zones:

1. **The Automation and Service Definitions (`/home/runner`):** Located on the fast OS disk, this is where all configurations, scripts, and service *definitions* live. This area is lightweight and ideal for version control (e.g., with Git).
2. **The ZFS-Managed Persistent Data (`/datapool`):** This is the large ZFS data pool. It *only* stores the persistent, heavy-lifting data generated by your services (e.g., databases, photo libraries, Git repositories).

-----

## Automation and Service Definitions

The `runner` user's home directory is the central hub for managing the entire homelab. It's split into two key parts.

### 1. The Automation Framework (`/home/runner/management/`)

This directory contains the scripts and tools that manage the server, run backups, and automate tasks. It's the "command center" of the VM.

This directory will better described in the [Automation layer](../3-automation/0_index.md) section.

### 2. The Service Definitions (`/home/runner/services/`)

This directory contains all your **Docker Compose files** and their related configurations. It defines *what* services run and *how* they are configured.

- **Structure:** Each service or stack (e.g., `git`, `photo`) gets its own sub-directory.
- **Contents:** Inside each service directory, you'll find:
  - `docker-compose.yml`: The file that defines the containers, networks, and volumes for that service.
  - `.env`: A configuration file *specific to that service*, defining things like ports, passwords, and data paths.
- **Why this structure?**
  1. **Clean Separation:** It separates the *configuration* of a service (the `docker-compose.yml`) from its *data* (which lives on the ZFS pool).
  2. **Version Control:** This entire `/home/runner/services` directory is "stateless". You can (and should) back it up or place it under Git version control without worrying about large data files.
  3. **Automation:** The management scripts can easily find, start, stop, and update all services by simply looking through the sub-directories here.

This directory will be better defined in the [Services layer](../2-services/0_index.md) section.

-----

## ZFS-Managed Persistent Data

This is where your applications' data *actually lives*. The ZFS pool is mounted at `/datapool` and is organized using ZFS datasets for maximum data integrity and snapshot capability.

 - **ZFS Hierarchy:** We create a parent dataset (`datapool/services`) and then a **dedicated child dataset for each service** (e.g., `datapool/services/git`, `datapool/services/photo`).
 - **Benefits:** This dataset-per-service model is the core of the backup strategy. It allows you to take an atomic, instantaneous snapshot of a single service's data before backing it up.

### Connecting the pieces

The "magic" happens in your `docker-compose.yml` files, where you map a service's data directory *inside* the container to its dedicated ZFS dataset *outside* on the host.

**Example:** For a Git service, its `docker-compose.yml` (located at `/home/runner/services/git/docker-compose.yml`) would contain a volume mapping like this:

```yaml
services:
 gitea:
  image: gitea/gitea:latest
  container_name: gitea
  volumes:
   # This line maps the container's /data directory to the host's ZFS dataset.
   - /datapool/services/git:/data
  ports:
   - "3000:3000"
```

This tells Docker: "Any file the 'gitea' container writes to its `/data` folder should actually be saved on the host at `/datapool/services/git`."

 - **For Complex Services:** If a service needs multiple data paths (e.g., a database, a library, and temp files), you simply create regular directories *within* its ZFS dataset.
   - Example: `/datapool/services/photo/database`
   - Example: `/datapool/services/photo/library`

-----

## Tying It All Together: The Full Directory Map

This tree diagram shows the complete, "filled" structure of the homelab, illustrating the separation of configuration (in `/home/runner`) and data (in `/datapool`).

```
/
├── home/
│ └── runner/
│  ├── management/            <- Automation
│  │ ├── Makefile             <- Your command entrypoint
│  │ ├── .env                 <- VM-wide "single point of truth"
│  │ ├── borg_excludes.txt
│  │ ├── python/              <- Automation scripts (backup logic, etc.)
│  │ └── borg_keys/           <- Borg encryption keys
│  └── services/              <- Service Definitions
│   ├── central_hub/
│   │ ├── docker-compose.yml  <- Service docker compose definition
│   │ └── .env                <- Config for this service
│   ├── git/
│   │ ├── docker-compose.yml  <- Service docker compose definition
│   │ └── .env                <- Config for this service
│   └── ...                   <- Other service configs
│
└── datapool/                 <- The "Memory" (ZFS Pool Mount Point)
 └── services/                <- ZFS Parent Dataset
  ├── git/                    <- ZFS Dataset (mounts /datapool/services/git)
  │ └── ...                   <- Actual Git application data
  ├── photo/                  <- ZFS Dataset (mounts /datapool/services/photo)
  │ ├── database/             <- App database data
  │ ├── library/              <- App media library
  │ └── temp_uploads/         <- App temp folder
  └── ...                     <- Other service datasets and their data
```